import { GetManyBaseQueryParams } from '@/common/dtos/get-many-base.dto';
import { Severity } from '@/common/enums/enum';
import { ApiProperty } from '@nestjs/swagger';
import { Transform } from 'class-transformer';
import {
  IsDateString,
  IsEnum,
  IsOptional,
  IsString,
  IsUUID,
} from 'class-validator';

export enum VulnerabilityStatus {
  OPEN = 'open',
  DISMISSED = 'dismissed',
  ALL = 'all',
}

export class GetVulnerabilitiesQueryDto extends GetManyBaseQueryParams {
  @ApiProperty()
  @IsUUID(4)
  workspaceId?: string;

  @ApiProperty({
    required: false,
    isArray: true,
  })
  @IsUUID(4, { each: true })
  @IsOptional()
  @Transform(
    ({ value }) => (Array.isArray(value) ? value : [value]) as string[],
  )
  targetIds?: string[];

  @ApiProperty({
    required: false,
  })
  @IsString()
  @IsOptional()
  q?: string;

  @ApiProperty({
    required: false,
    enum: VulnerabilityStatus,
    default: VulnerabilityStatus.OPEN,
    description: 'Filter by vulnerability status: open, dismissed, or all',
  })
  @IsEnum(VulnerabilityStatus)
  @IsOptional()
  status?: VulnerabilityStatus = VulnerabilityStatus.OPEN;

  @ApiProperty({
    required: false,
    isArray: true,
    enum: Severity,
    description: 'Filter by severity levels: info, low, medium, high, critical',
  })
  @IsEnum(Severity, { each: true })
  @IsOptional()
  @Transform(
    ({ value }) => (Array.isArray(value) ? value : [value]) as Severity[],
  )
  severity?: Severity[];

  @ApiProperty({
    required: false,
    description: 'Filter by creation date from (ISO 8601 format, e.g., 2026-01-01)',
    example: '2026-01-01',
  })
  @IsDateString()
  @IsOptional()
  createdFrom?: string;

  @ApiProperty({
    required: false,
    description: 'Filter by creation date to (ISO 8601 format, e.g., 2026-01-31)',
    example: '2026-01-31',
  })
  @IsDateString()
  @IsOptional()
  createdTo?: string;
}
