version: '3'

vars:
  replicas: '{{.replicas | default 1}}'
  apiKey: '{{.apiKey | default .API_KEY}}'
  maxJobs: '{{.maxJobs | default .MAX_JOBS}}'

tasks:
  dev:
    env:
      API_KEY: '{{.apiKey}}'
      MAX_JOBS: '{{.maxJobs}}'
    cmds:
      - |
        for i in $(seq 1 {{.replicas}}); do
          echo "Starting worker $i"
          bun --watch index.ts &
        done
        wait
    silent: false

  install:
    cmds:
      - bun install
  clean:
    cmds:
      - rm -rf ./husky
      - rm -rf ./node_modules
      - rm -rf ./dist

  tools:
    cmds:
      - go install -v github.com/projectdiscovery/pdtm/cmd/pdtm@latest
      - pdtm -duc -dc -install-go-path -install httpx,subfinder,nuclei,dnsx,naabu
  build:
    cmds:
      - bun run build
