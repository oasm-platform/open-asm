import { Button } from '@/components/ui/button';
import { DataTable } from '@/components/ui/data-table';
import { useServerDataTable } from '@/hooks/useServerDataTable';
import { useWorkspaceSelector } from '@/hooks/useWorkspaceSelector';
import type { Vulnerability } from '@/services/apis/gen/queries';
import { useVulnerabilitiesControllerGetVulnerabilities } from '@/services/apis/gen/queries';
import { BellOff } from 'lucide-react';
import { useMemo, useState } from 'react';
import { useLocation } from 'react-router-dom';
import CreateWorkspace from '../workspaces/create-workspace';
import { DismissAlertDialog } from './components/dismiss-dialog';
import DetailSheet from './components/detail-sheet';
import { vulnerabilityColumns } from './vulnerablity-columns';

export function ListVulnerabilities({ targetId }: { targetId?: string }) {
  const { selectedWorkspace, workspaces } = useWorkspaceSelector();
  const location = useLocation();
  const [vulId, setVulId] = useState('');
  const [open, setOpen] = useState(false);
  const [rowSelection, setRowSelection] = useState<Record<string, boolean>>({});

  const {
    tableParams: { page, pageSize, sortBy, sortOrder, filter },
    tableHandlers: { setPage, setPageSize, setSortBy, setSortOrder, setFilter },
  } = useServerDataTable({
    defaultSortBy: 'severity',
    defaultSortOrder: 'DESC',
  });

  // Extract targetId from URL search params if present
  const urlParams = new URLSearchParams(location.search);
  const urlTargetId = urlParams.get('targetId') || undefined;

  // Use targetId from props if provided, otherwise use from URL
  const effectiveTargetId = targetId || urlTargetId;

  const { data, isLoading, refetch } =
    useVulnerabilitiesControllerGetVulnerabilities(
      {
        workspaceId: selectedWorkspace ?? '',
        targetIds: effectiveTargetId ? [effectiveTargetId] : undefined,
        limit: pageSize,
        page,
        sortBy,
        sortOrder,
        q: filter || undefined,
      },
      {
        query: {
          refetchInterval: 5000,
          queryKey: [
            'vulnerabilities',
            selectedWorkspace,
            effectiveTargetId,
            page,
            pageSize,
            sortBy,
            sortOrder,
            filter,
          ],
        },
      },
    );

  const vulnerabilities = useMemo(() => data?.data ?? [], [data?.data]);
  const total = data?.total ?? 0;

  // Get selected vulnerabilities data for bulk actions
  const selectedVulnerabilities = useMemo(() => {
    return vulnerabilities.filter((_, index) => rowSelection[String(index)]);
  }, [vulnerabilities, rowSelection]);

  const handleBulkDismissSuccess = () => {
    setRowSelection({});
    refetch();
  };

  if (workspaces.length === 0) return <CreateWorkspace />;
  if (!data && !isLoading) return <div>Error loading vulnerabilities.</div>;

  return (
    <>
      <DataTable<Vulnerability, unknown>
        data={vulnerabilities}
        columns={vulnerabilityColumns}
        isLoading={isLoading}
        page={page}
        pageSize={pageSize}
        sortBy={sortBy}
        sortOrder={sortOrder}
        onPageChange={setPage}
        onPageSizeChange={setPageSize}
        onSortChange={(col, order) => {
          setSortBy(col);
          setSortOrder(order);
        }}
        filterColumnKey="__search__"
        filterValue={filter}
        onFilterChange={setFilter}
        totalItems={total}
        rowClassName="cursor-pointer hover:bg-muted/50 transition-colors"
        onRowClick={(row) => {
          setVulId(row.id);
          setOpen(true);
        }}
        rowSelection={rowSelection}
        onRowSelectionChange={setRowSelection}
        selectionHeader={(count) => (
          <div className="flex items-center gap-3">
            <span className="text-sm font-medium">{count} selected</span>
            <DismissAlertDialog
              vulnerabilityIds={selectedVulnerabilities.map((v) => v.id)}
              vulnerabilityName={
                count === 1
                  ? selectedVulnerabilities[0]?.name
                  : `${count} vulnerabilities`
              }
              trigger={
                <Button variant="outline" size="sm">
                  <BellOff className="h-4 w-4 mr-1" />
                  Dismiss alerts
                </Button>
              }
              onDismissSuccess={handleBulkDismissSuccess}
            />
          </div>
        )}
      />
      <DetailSheet vulId={vulId} open={open} setOpen={setOpen} />
    </>
  );
}
