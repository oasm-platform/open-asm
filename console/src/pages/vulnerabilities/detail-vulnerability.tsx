import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import Image from '@/components/ui/image';
import { SeverityBadge } from '@/components/ui/severity-badge';
import Page from '@/components/common/page';
import {
  useVulnerabilitiesControllerGetVulnerabilityById,
  useVulnerabilitiesControllerReopenVulnerability,
} from '@/services/apis/gen/queries';
import {
  AlertTriangle,
  BellOff,
  BellRing,
  Check,
  Code,
  Copy,
  Cpu,
  ExternalLink,
  FileText,
  Info,
  Link as LinkIcon,
  Loader2,
  MessageSquare,
  Network,
  Shield,
  ShieldAlert,
  Tag,
  UserCircle2,
  Users,
} from 'lucide-react';
import { useState, useCallback } from 'react';
import { Link, useNavigate, useParams } from 'react-router-dom';
import { DismissAlertDialog } from './components/dismiss-dialog';
import { toast } from 'sonner';

function CopyButton({ text }: { text: string }) {
  const [copied, setCopied] = useState(false);

  const handleCopy = useCallback(async () => {
    await navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  }, [text]);

  return (
    <Button
      variant="ghost"
      size="sm"
      onClick={handleCopy}
      className="h-6 px-2 shrink-0"
    >
      {copied ? (
        <Check className="h-3 w-3 text-green-500" />
      ) : (
        <Copy className="h-3 w-3" />
      )}
    </Button>
  );
}

/**
 * Maps dismiss reason enum value to human-readable label
 */
function getDismissReasonLabel(reason: string): string {
  const reasonLabels: Record<string, string> = {
    false_positive: 'False positive',
    used_in_test: 'Used in tests',
    wont_fix: "Won't fix",
  };
  return reasonLabels[reason] || reason;
}

/**
 * Button component to reopen a dismissed vulnerability alert.
 * Shows loading state during the API call and displays success/error toasts.
 */
function ReopenButton({
  vulnerabilityId,
  onReopenSuccess,
}: {
  vulnerabilityId: string;
  onReopenSuccess?: () => void;
}) {
  const reopenMutation = useVulnerabilitiesControllerReopenVulnerability();

  const handleReopen = () => {
    reopenMutation.mutate(
      { id: vulnerabilityId },
      {
        onSuccess: () => {
          toast.success('Alert reopened', {
            description:
              'The vulnerability has been restored to active tracking.',
          });
          onReopenSuccess?.();
        },
        onError: (error) => {
          toast.error('Failed to reopen alert', {
            description:
              error instanceof Error
                ? error.message
                : 'An unexpected error occurred.',
          });
        },
      },
    );
  };

  return (
    <Button
      variant="outline"
      size="sm"
      onClick={handleReopen}
      disabled={reopenMutation.isPending}
    >
      {reopenMutation.isPending ? (
        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
      ) : (
        <BellRing className="h-4 w-4 mr-2" />
      )}
      Reopen alert
    </Button>
  );
}

export default function DetailVulnerability() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();

  const { data, isLoading, error, refetch } =
    useVulnerabilitiesControllerGetVulnerabilityById(id || '');

  if (isLoading) {
    return (
      <Page isShowButtonGoBack>
        <div className="flex items-center justify-center h-64">
          <Loader2 className="w-8 h-8 animate-spin" />
        </div>
      </Page>
    );
  }

  if (error || !data) {
    return (
      <Page isShowButtonGoBack>
        <div className="text-center py-12">
          <h2 className="text-xl font-semibold">Vulnerability not found</h2>
          <p className="text-muted-foreground mt-2">
            The vulnerability you're looking for doesn't exist or you don't have
            permission to view it.
          </p>
          <Button className="mt-4" onClick={() => navigate(-1)}>
            Go back
          </Button>
        </div>
      </Page>
    );
  }

  return (
    <Page
      title={data.name}
      isShowButtonGoBack
      header={
        <div className="flex items-center gap-3 justify-end">
          {data.vulnerabilityDismissal ? (
            <ReopenButton
              vulnerabilityId={id || ''}
              onReopenSuccess={() => refetch()}
            />
          ) : (
            <DismissAlertDialog
              vulnerabilityId={id || ''}
              vulnerabilityName={data.name}
              trigger={
                <Button variant="outline" size="sm">
                  <BellOff className="h-4 w-4 mr-2" />
                  Dismiss alert
                </Button>
              }
              onDismissSuccess={() => refetch()}
            />
          )}
          <SeverityBadge severity={data.severity || 'info'} />
        </div>
      }
    >
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 py-4">
        {/* Main Content - Left 2 Columns */}
        <div className="lg:col-span-2 space-y-6">
          {/* Overview Card */}
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="flex items-center gap-2 text-lg">
                <FileText className="h-5 w-5 text-primary" />
                Overview
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {data.synopsis && typeof data.synopsis === 'string' && (
                <div>
                  <h4 className="text-sm font-medium text-muted-foreground mb-1">
                    Synopsis
                  </h4>
                  <p className="text-sm leading-relaxed whitespace-pre-wrap">
                    {data.synopsis}
                  </p>
                </div>
              )}
              {data.description && (
                <div>
                  <h4 className="text-sm font-medium text-muted-foreground mb-1">
                    Description
                  </h4>
                  <p className="text-sm leading-relaxed">{data.description}</p>
                </div>
              )}
              {data.tags &&
                Array.isArray(data.tags) &&
                data.tags.length > 0 && (
                  <div className="flex flex-wrap gap-2 pt-2">
                    {data.tags.map((tag: string) => (
                      <Badge
                        key={tag}
                        variant="secondary"
                        className="flex items-center gap-1"
                      >
                        <Tag size={12} /> {tag}
                      </Badge>
                    ))}
                  </div>
                )}
            </CardContent>
          </Card>

          {/* Network & Metrics Card */}
          {(data.affectedUrl ||
            data.ipAddress ||
            data.host ||
            (data.ports && data.ports.length > 0) ||
            data.cvssMetric) && (
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Network className="h-5 w-5 text-cyan-500" />
                  Network & Metrics
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {data.affectedUrl && (
                    <div className="md:col-span-2 p-3 rounded-lg bg-muted/50">
                      <h4 className="text-sm font-medium text-muted-foreground mb-1">
                        Affected URL
                      </h4>
                      <div className="flex items-center gap-2">
                        <a
                          href={data.affectedUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-500 hover:text-blue-600 hover:underline transition-colors break-all text-sm"
                        >
                          {data.affectedUrl}
                        </a>
                        <CopyButton text={data.affectedUrl} />
                      </div>
                    </div>
                  )}
                  {data.host && (
                    <div className="p-3 rounded-lg bg-muted/50">
                      <h4 className="text-sm font-medium text-muted-foreground mb-1">
                        Host
                      </h4>
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-sm break-all">
                          {data.host}
                        </span>
                        <CopyButton text={data.host} />
                      </div>
                    </div>
                  )}
                  {data.ipAddress && (
                    <div className="p-3 rounded-lg bg-muted/50">
                      <h4 className="text-sm font-medium text-muted-foreground mb-1">
                        IP Address
                      </h4>
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-sm">
                          {data.ipAddress}
                        </span>
                        <CopyButton text={data.ipAddress} />
                      </div>
                    </div>
                  )}
                  {data.ports &&
                    Array.isArray(data.ports) &&
                    data.ports.length > 0 && (
                      <div className="p-3 rounded-lg bg-muted/50">
                        <h4 className="text-sm font-medium text-muted-foreground mb-1">
                          Ports
                        </h4>
                        <div className="flex flex-wrap gap-1.5">
                          {data.ports.map((port: string) => (
                            <Badge
                              key={port}
                              variant="outline"
                              className="font-mono"
                            >
                              {port}
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  {data.cvssMetric && (
                    <div className="md:col-span-2 p-3 rounded-lg bg-muted/50">
                      <h4 className="text-sm font-medium text-muted-foreground mb-1">
                        CVSS Vector
                      </h4>
                      <div className="flex items-center gap-2">
                        <code className="text-xs bg-background px-2 py-1 rounded font-mono border">
                          {data.cvssMetric}
                        </code>
                        <CopyButton text={data.cvssMetric} />
                      </div>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Solution Card */}
          {data.solution && (
            <Card className="border-emerald-500/20">
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-lg text-emerald-600 dark:text-emerald-400">
                  <Shield className="h-5 w-5" />
                  Solution
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="bg-emerald-500/5 rounded-lg p-4 border border-emerald-500/20">
                  <pre className="whitespace-pre-wrap leading-relaxed text-sm font-mono">
                    {data.solution}
                  </pre>
                </div>
              </CardContent>
            </Card>
          )}

          {/* References Card */}
          {((data.references && data.references.length > 0) ||
            data.cveUrl ||
            data.cweUrl) && (
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-lg">
                  <LinkIcon className="h-5 w-5 text-teal-500" />
                  References
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {data.cveUrl && (
                    <a
                      href={data.cveUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 text-blue-500 hover:text-blue-600 hover:underline transition-colors text-sm p-2 rounded-lg hover:bg-muted/50"
                    >
                      <ExternalLink className="h-4 w-4 shrink-0" />
                      <span className="break-all">{data.cveUrl}</span>
                    </a>
                  )}
                  {data.cweUrl && (
                    <a
                      href={data.cweUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 text-blue-500 hover:text-blue-600 hover:underline transition-colors text-sm p-2 rounded-lg hover:bg-muted/50"
                    >
                      <ExternalLink className="h-4 w-4 shrink-0" />
                      <span className="break-all">{data.cweUrl}</span>
                    </a>
                  )}
                  {data.references &&
                    Array.isArray(data.references) &&
                    data.references.length > 0 && (
                      <div className="space-y-2">
                        {data.references.map((ref: string) => (
                          <a
                            key={ref}
                            href={ref}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="flex items-center gap-2 text-blue-500 hover:text-blue-600 hover:underline transition-colors text-sm p-2 rounded-lg hover:bg-muted/50"
                          >
                            <ExternalLink className="h-4 w-4 shrink-0" />
                            <span className="break-all">{ref}</span>
                          </a>
                        ))}
                      </div>
                    )}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Extracted Results Card */}
          {data.extractedResults &&
            Array.isArray(data.extractedResults) &&
            data.extractedResults.length > 0 && (
              <Card>
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2 text-lg">
                    <Code className="h-5 w-5 text-fuchsia-500" />
                    Extracted Results
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    {data.extractedResults.map(
                      (result: string, index: number) => (
                        <div
                          key={index}
                          className="font-mono text-xs bg-muted p-3 rounded-lg border-l-2 border-fuchsia-500 break-all"
                        >
                          {result}
                        </div>
                      ),
                    )}
                  </div>
                </CardContent>
              </Card>
            )}
        </div>

        {/* Sidebar - Right Column */}
        <div className="space-y-6">
          {/* Dismiss Info Card - Only shown when vulnerability is dismissed */}
          {data.vulnerabilityDismissal && (
            <Card className="border-amber-500/30 bg-amber-500/5">
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-lg text-amber-600 dark:text-amber-400">
                  <BellOff className="h-5 w-5" />
                  Dismissed
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {/* Reason */}
                  <div className="p-3 rounded-lg bg-muted/50">
                    <h4 className="text-xs font-medium text-muted-foreground mb-1">
                      Reason
                    </h4>
                    <Badge variant="secondary" className="font-medium">
                      {getDismissReasonLabel(
                        data.vulnerabilityDismissal.reason,
                      )}
                    </Badge>
                  </div>

                  {/* Dismissed by */}
                  {(data.vulnerabilityDismissal as { user?: { name?: string } })
                    .user?.name && (
                    <div className="p-3 rounded-lg bg-muted/50">
                      <h4 className="text-xs font-medium text-muted-foreground mb-1 flex items-center gap-1">
                        <UserCircle2 className="h-3 w-3" />
                        Dismissed by
                      </h4>
                      <p className="text-sm font-medium">
                        {
                          (
                            data.vulnerabilityDismissal as {
                              user?: { name?: string };
                            }
                          ).user?.name
                        }
                      </p>
                    </div>
                  )}

                  {/* Comment */}
                  {data.vulnerabilityDismissal.comment && (
                    <div className="p-3 rounded-lg bg-muted/50">
                      <h4 className="text-xs font-medium text-muted-foreground mb-1 flex items-center gap-1">
                        <MessageSquare className="h-3 w-3" />
                        Comment
                      </h4>
                      <p className="text-sm text-foreground/80 leading-relaxed">
                        {data.vulnerabilityDismissal.comment}
                      </p>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Scores Card */}
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="flex items-center gap-2 text-lg">
                <AlertTriangle className="h-5 w-5 text-rose-500" />
                Risk Scores
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                  <span className="text-sm text-muted-foreground">
                    Severity
                  </span>
                  <SeverityBadge severity={data.severity || 'info'} />
                </div>
                {data.cvssScore !== undefined && data.cvssScore !== null && (
                  <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                    <span className="text-sm text-muted-foreground">
                      CVSS Score
                    </span>
                    <Badge variant="outline" className="font-bold text-lg">
                      {data.cvssScore.toFixed(1)}
                    </Badge>
                  </div>
                )}
                {data.epssScore !== undefined && data.epssScore !== null && (
                  <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                    <span className="text-sm text-muted-foreground">
                      EPSS Score
                    </span>
                    <Badge variant="outline" className="font-bold">
                      {(data.epssScore * 100).toFixed(2)}%
                    </Badge>
                  </div>
                )}
                {data.vprScore !== undefined && data.vprScore !== null && (
                  <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                    <span className="text-sm text-muted-foreground">
                      VPR Score
                    </span>
                    <Badge variant="outline" className="font-bold">
                      {data.vprScore.toFixed(1)}
                    </Badge>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Identifiers Card */}
          {(data.cveId ||
            data.cweId ||
            data.bidId ||
            data.ceaId ||
            data.iava) && (
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-lg">
                  <ShieldAlert className="h-5 w-5 text-pink-500" />
                  Identifiers
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {data.cveId &&
                    Array.isArray(data.cveId) &&
                    data.cveId.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-muted-foreground mb-2">
                          CVE
                        </h4>
                        <div className="flex flex-wrap gap-1.5">
                          {data.cveId.map((cve: string) => (
                            <Badge
                              key={cve}
                              variant="destructive"
                              className="font-mono text-xs"
                            >
                              {cve}
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  {data.cweId &&
                    Array.isArray(data.cweId) &&
                    data.cweId.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-muted-foreground mb-2">
                          CWE
                        </h4>
                        <div className="flex flex-wrap gap-1.5">
                          {data.cweId.map((cwe: string) => (
                            <Badge
                              key={cwe}
                              variant="outline"
                              className="font-mono text-xs"
                            >
                              {cwe}
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  {data.bidId &&
                    Array.isArray(data.bidId) &&
                    data.bidId.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-muted-foreground mb-2">
                          BID
                        </h4>
                        <div className="flex flex-wrap gap-1.5">
                          {data.bidId.map((bid: string) => (
                            <Badge
                              key={bid}
                              variant="outline"
                              className="font-mono text-xs"
                            >
                              {bid}
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  {data.ceaId &&
                    Array.isArray(data.ceaId) &&
                    data.ceaId.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-muted-foreground mb-2">
                          CEA
                        </h4>
                        <div className="flex flex-wrap gap-1.5">
                          {data.ceaId.map((cea: string) => (
                            <Badge
                              key={cea}
                              variant="outline"
                              className="font-mono text-xs"
                            >
                              {cea}
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  {data.iava &&
                    Array.isArray(data.iava) &&
                    data.iava.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-muted-foreground mb-2">
                          IAVA
                        </h4>
                        <div className="flex flex-wrap gap-1.5">
                          {data.iava.map((iava: string) => (
                            <Badge
                              key={iava}
                              variant="outline"
                              className="font-mono text-xs"
                            >
                              {iava}
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Authors Card */}
          {data.authors &&
            Array.isArray(data.authors) &&
            data.authors.length > 0 && (
              <Card>
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2 text-lg">
                    <Users className="h-5 w-5 text-violet-500" />
                    Authors
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="flex flex-wrap gap-2">
                    {data.authors.map((author: string) => (
                      <Badge
                        key={author}
                        variant="secondary"
                        className="flex items-center gap-1"
                      >
                        <Users size={12} /> {author}
                      </Badge>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}

          {/* Metadata Card */}
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="flex items-center gap-2 text-lg">
                <Info className="h-5 w-5 text-slate-500" />
                Metadata
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {data.extractorName && (
                  <div>
                    <h4 className="text-xs font-medium text-muted-foreground">
                      Extractor
                    </h4>
                    <p className="text-sm">{data.extractorName}</p>
                  </div>
                )}
                <div>
                  <h4 className="text-xs font-medium text-muted-foreground">
                    Discovered
                  </h4>
                  <p className="text-sm">
                    {data.createdAt
                      ? new Date(data.createdAt).toLocaleString('en-US', {
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit',
                        })
                      : 'Unknown'}
                  </p>
                </div>
                <div>
                  <h4 className="text-xs font-medium text-muted-foreground">
                    Last Updated
                  </h4>
                  <p className="text-sm">
                    {data.updatedAt
                      ? new Date(data.updatedAt).toLocaleString('en-US', {
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit',
                        })
                      : 'Unknown'}
                  </p>
                </div>
                {data.publicationDate && (
                  <div>
                    <h4 className="text-xs font-medium text-muted-foreground">
                      Published
                    </h4>
                    <p className="text-sm">
                      {new Date(data.publicationDate).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                      })}
                    </p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Tool Card */}
          {data.tool && (
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Cpu className="h-5 w-5 text-blue-500" />
                  Scanned By
                </CardTitle>
              </CardHeader>
              <CardContent>
                <Link to={`/tools/${data.tool.id}`}>
                  <div className="flex items-center gap-3 p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors cursor-pointer">
                    <Image
                      url={data.tool.logoUrl}
                      width={48}
                      height={48}
                      className="rounded-lg"
                    />
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-sm">
                        {data.tool.name.charAt(0).toUpperCase() +
                          data.tool.name.slice(1)}
                      </p>
                      {data.tool.version && (
                        <Badge variant="secondary" className="text-xs mt-1">
                          v{data.tool.version}
                        </Badge>
                      )}
                    </div>
                    <ExternalLink className="h-4 w-4 text-muted-foreground" />
                  </div>
                </Link>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </Page>
  );
}
